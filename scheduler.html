<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Cleaning Scheduler with Routing</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin="" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .clearfix { display: flex; }
    #map { flex: 1; height: 600px; border: 1px solid #ccc; margin-right: 20px; }
    .sidebar { width: 300px; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, button, textarea { width: 100%; margin-top: 4px; padding: 6px; box-sizing: border-box; }
    textarea { resize: vertical; }
    ul { list-style: none; padding: 0; }
    #scheduleOutput h3 { cursor: pointer; margin: 10px 0 5px; }
  </style>
</head>
<body>
  <h1>Daily Cleaning Scheduler</h1>
  <div class="clearfix">
    <div id="map"></div>
    <div class="sidebar">
      <h2>Employees</h2>
      <table id="empTable">
        <thead><tr><th>Name</th><th>Size</th><th>On Duty</th></tr></thead>
        <tbody></tbody>
      </table>
      <button id="generate">Generate Routes & Schedule</button>
      <div id="scheduleOutput"></div>
      <div id="routeStats"></div>
      <hr>
      <h2>Add Job</h2>
      <label>Subdivision</label><input id="subdivisionInput" list="subdivisionList"><datalist id="subdivisionList"></datalist>
      <label>Lot #</label><input id="lotInput">
      <label>Address</label><input id="addressInput">
      <label>Period</label><select id="periodSelect"><option>Normal</option><option>AM</option><option>PM</option></select>
      <label>Type</label><select id="typeSelect"><option>Original</option><option>Reclean</option><option>Custom</option></select>
      <label id="noteLabel" style="display:none;">Note</label><input id="noteInput" style="display:none;">
      <button id="addJob">Add Job</button>
      <hr>
      <h2>Import Jobs</h2>
      <textarea id="bulkInput" rows="4" placeholder="[AM/PM] Lot Subdivision [type] - Address"></textarea>
      <button id="importBtn">Import Jobs</button>
      <ul id="jobList"></ul>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    const ORS_API_KEY = '5b3ce3597851110001cf624895d5d8857d8d41b6a9508753893fbb25';
    const EMP_KEY = 'sched_employees', JOB_KEY = 'sched_jobs';
    // Sample subdivisions
    const subdivisions = [ ['Pulte','Longview',39.89768,-82.78979], ['Pulte','Bloomfield',39.70813,-82.98888] /* ... */ ];
    const subMap = {}, subdivisionList = document.getElementById('subdivisionList');
    subdivisions.forEach(([b,sub,lat,lng])=>{
      subMap[sub.toLowerCase()] = {b,sub,lat,lng};
      const opt = document.createElement('option'); opt.value = sub;
      subdivisionList.appendChild(opt);
    });

    const employees = [ {name:'Ana',size:2},{name:'Aracely',size:2},{name:'Barb',size:1} /* ... */ ];
    let empState = JSON.parse(localStorage.getItem(EMP_KEY) || '[]');
    let jobs = JSON.parse(localStorage.getItem(JOB_KEY) || '[]');

    // DOM refs
    const empTable = document.getElementById('empTable');
    const generateBtn = document.getElementById('generate');
    const scheduleOutput = document.getElementById('scheduleOutput');
    const routeStats = document.getElementById('routeStats');
    const jobList = document.getElementById('jobList');
    const addJobBtn = document.getElementById('addJob');
    const importBtn = document.getElementById('importBtn');

    // Populate employees
    employees.forEach((e,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${e.name}</td><td>${e.size}</td><td><input type="checkbox" class="toggle" ${empState[i]!==false?'checked':''}></td>`;
      tr.querySelector('.toggle').addEventListener('change',()=>{
        empState[i] = tr.querySelector('.toggle').checked;
        localStorage.setItem(EMP_KEY, JSON.stringify(empState));
      });
      empTable.querySelector('tbody').appendChild(tr);
    });

    function renderJobs(){ jobList.innerHTML=''; jobs.forEach((j,i)=>{
      const li = document.createElement('li'); li.textContent = `*${j.lot} ${j.sub} ${j.type.toLowerCase()} – ${j.address}`;
      const btn = document.createElement('button'); btn.textContent='×'; btn.addEventListener('click',()=>{jobs.splice(i,1);localStorage.setItem(JOB_KEY,JSON.stringify(jobs));renderJobs();});
      li.appendChild(btn); jobList.appendChild(li);
    }); }
    renderJobs();

    function addJob(sub,lot,address,period,type){ jobs.push({sub,lot,address,period,type}); localStorage.setItem(JOB_KEY,JSON.stringify(jobs)); renderJobs(); }

    addJobBtn.addEventListener('click',()=>{
      const sub = subdivisionInput.value.toLowerCase(); const lot = lotInput.value.trim(); const address = addressInput.value.trim();
      const period = periodSelect.value; const type = typeSelect.value;
      if(!sub||!lot||!address) return alert('Missing fields');
      const info = subMap[sub]||{};
      addJob(info.sub||sub, lot, address, period, type);
      lotInput.value='';addressInput.value='';periodSelect.value='Normal';typeSelect.value='Original';
    });

    importBtn.addEventListener('click',()=>{
      bulkInput.value.split(/\r?\n/).filter(l=>l).forEach(line=>{
        let period='Normal', txt=line;
        if(/^AM /i.test(txt)){period='AM';txt=txt.slice(3);}else if(/^PM /i.test(txt)){period='PM';txt=txt.slice(3);}
        const m=txt.match(/^(\d+)\s+(.+?)\s*(reclean|original)?\s*[-–]\s*(.+)$/i);
        if(!m) return;
        const [_,lot,sub,typeRaw,address] = m;
        const type=typeRaw?typeRaw.charAt(0).toUpperCase()+typeRaw.slice(1).toLowerCase():'Original';
        const info = subMap[sub.toLowerCase()]||{};
        addJob(info.sub||sub, lot, address, period, type);
      }); bulkInput.value='';
    });

    // Initialize map
    const map = L.map('map').setView([39.9,-82.9],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

    let layers = [], currentAssign = {};

    async function getRoute(from, to){
      const res = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson',{method:'POST',headers:{Authorization:ORS_API_KEY,'Content-Type':'application/json'},body:JSON.stringify({coordinates:[[from.lng,from.lat],[to.lng,to.lat]]})});
      return res.json();
    }

    generateBtn.addEventListener('click', async()=>{
      // Clear map
      layers.forEach(l=>map.removeLayer(l)); layers=[];
      // Get on-duty staff
      const onDuty = employees.filter((_,i)=>empState[i]!==false);
      if(!jobs.length||!onDuty.length) return alert('Add jobs & enable staff');
      // Nearest neighbor by drive time
      const assign = {}; onDuty.forEach(e=>assign[e.name]=[]);
      const locs = {};
      let un = [...jobs];
      while(un.length){
        for(const e of onDuty){
          if(e.name==='Barb'&&assign[e.name].length>=1) continue;
          if(!un.length) break;
          let bestIdx=0, bestDur=Infinity;
          for(let i=0; i<un.length; i++){
            const job = un[i];
            const base = locs[e.name] || job;
            const from = {lat:(subMap[base.sub.toLowerCase()]||{}).lat, lng:(subMap[base.sub.toLowerCase()]||{}).lng};
            const to = {lat:(subMap[job.sub.toLowerCase()]||{}).lat, lng:(subMap[job.sub.toLowerCase()]||{}).lng};
            if(!from.lat||!to.lat) continue;
            const r = await getRoute(from,to);
            const dur = r.features[0].properties.summary.duration;
            if(dur<bestDur){bestDur=dur; bestIdx=i;}
          }
          const job = un.splice(bestIdx,1)[0];
          assign[e.name].push(job);
          locs[e.name] = job;
        }
      }
      currentAssign = assign;
      // Render schedule
      scheduleOutput.innerHTML=''; routeStats.innerHTML='';
      onDuty.forEach(e=>{
        const h = document.createElement('h3'); h.textContent=e.name;
        h.addEventListener('click', ()=>showRoute(e.name)); scheduleOutput.appendChild(h);
        const ul = document.createElement('ul');
        (async () => {
            for (let i = 0; i < currentAssign[e.name].length; i++) {
              const j = currentAssign[e.name][i];
              let text = `*${j.lot} ${j.sub} ${j.type.toLowerCase()} – ${j.address}`;
              if (i < currentAssign[e.name].length - 1) {
                const next = currentAssign[e.name][i+1];
                const a = subMap[j.sub.toLowerCase()];
                const b = subMap[next.sub.toLowerCase()];
                if (a && b) {
                  const r = await getRoute({ lat: a.lat, lng: a.lng }, { lat: b.lat, lng: b.lng });
                  const mins = (r.features[0].properties.summary.duration/60).toFixed(1);
                  text += ` (${mins} min)`;
                }
              }
              const li = document.createElement('li');
              li.textContent = text;
              ul.appendChild(li);
            }
          })();
        scheduleOutput.appendChild(ul);
      });
    });

    async function showRoute(empName) {
      // Clear previous layers
      layers.forEach(l => map.removeLayer(l));
      layers = [];

      const arr = currentAssign[empName];
      if (!arr || arr.length === 0) return;

      // If only one job, show a marker
      if (arr.length === 1) {
        const subKey = arr[0].sub.toLowerCase();
        const coord = subMap[subKey];
        if (!coord) return;
        const marker = L.marker([coord.lat, coord.lng]).addTo(map);
        layers.push(marker);
        map.setView([coord.lat, coord.lng], 12);
        routeStats.innerHTML = `<h3>${empName} Route</h3><p>Single job: ${arr[0].sub} – ${arr[0].address}</p>`;
        return;
      }

      let totalDist = 0, totalDur = 0;
      // Multiple jobs: plot polylines
      for (let i = 0; i < arr.length - 1; i++) {
        const aKey = arr[i].sub.toLowerCase();
        const bKey = arr[i+1].sub.toLowerCase();
        const a = subMap[aKey];
        const b = subMap[bKey];
        if (!a || !b) continue;
        const r = await getRoute({ lat: a.lat, lng: a.lng }, { lat: b.lat, lng: b.lng });
        const sum = r.features[0].properties.summary;
        totalDist += sum.distance;
        totalDur += sum.duration;
        const pts = r.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
        const pl = L.polyline(pts, { color: '#f00' }).addTo(map);
        layers.push(pl);
        if (i === 0) {
          map.setView([a.lat, a.lng], 12);
        }
      }
      const miles = totalDist / 1609.34;
      const mins = totalDur / 60;
      routeStats.innerHTML = `<h3>${empName} Route</h3><p>Total: ${miles.toFixed(1)} mi, ${mins.toFixed(1)} min</p>`;
    }
  </script>
</body>
</html>
