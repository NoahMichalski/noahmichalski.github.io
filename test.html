<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moisture Fleet Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background:#0e1525; color:#fff; font-family:system-ui, sans-serif; margin:20px; }
    h1 { margin-bottom:10px; }
    #filters { margin-bottom:20px; }
    #filters button {
      padding:6px 12px; border:none; border-radius:4px;
      background:#1c3c5a; color:#fff; cursor:pointer; font-size:13px; margin-right:8px;
    }
    #filters button:hover { background:#2d5b85; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(350px,1fr)); gap:20px; }
    .card {
      background:#1c2333; border-radius:10px; padding:15px;
      box-shadow:0 2px 8px rgba(0,0,0,0.5); position:relative;
    }
    .card.offline-card { background:#2a2a2a; opacity:0.7; }
    .status {
      position:absolute; top:10px; right:10px;
      padding:4px 10px; border-radius:6px; font-weight:bold;
    }
    .ok { background:#1e7d32; }
    .warn { background:#e69500; }
    .alert { background:#c62828; }
    .offline { background:#555; }
    h2 { font-size:16px; margin:0 0 10px; }
    .editable { margin:4px 0; }
    .editable button { margin-left:6px; font-size:11px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Basement Humidity — Fleet Dashboard</h1>
  <div id="filters">
    <button onclick="setFilter('all')">All</button>
    <button onclick="setFilter('online')">Online Only</button>
    <button onclick="setFilter('offline')">Offline Only</button>
  </div>
  <div class="grid" id="cards"></div>

  <script>
    const { createClient } = supabase;
    const supabaseUrl = "https://imsqijcraukqqopntsmc.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imltc3FpamNyYXVrcXFvcG50c21jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNjQ2NzIsImV4cCI6MjA3MTg0MDY3Mn0.kT7uJbbyEYo-nvrg973B8BLfXmPU5rmcB1bh_ZIXIdM"; // replace with anon key
    const db = createClient(supabaseUrl, supabaseKey);

    let currentFilter = "all";

    function setFilter(mode) {
      currentFilter = mode;
      loadData();
    }

    function getStatus(humidity, lastSeenDate) {
      if (!lastSeenDate) return { text: "OFFLINE", class: "offline" };

      const now = new Date();
      const last = new Date(lastSeenDate);
      const diffHrs = (now - last) / (1000 * 60 * 60);
      if (diffHrs > 2) return { text: "OFFLINE", class: "offline" };

      if (humidity < 65) return { text: "OK", class: "ok" };
      if (humidity < 75) return { text: "WARN", class: "warn" };
      return { text: "ALERT", class: "alert" };
    }

    function timeAgo(dateStr) {
      if (!dateStr) return "Never";
      const now = new Date();
      const date = new Date(dateStr);
      const diffMs = now - date;
      const diffMin = Math.floor(diffMs / 60000);
      if (diffMin < 1) return "just now";
      if (diffMin < 60) return `${diffMin}m ago`;
      const diffHrs = Math.floor(diffMin / 60);
      if (diffHrs < 24) return `${diffHrs}h ago`;
      const diffDays = Math.floor(diffHrs / 24);
      return `${diffDays}d ago`;
    }

    async function loadData() {
      let { data, error } = await db
        .from("devices")
        .select(`
          id,
          lot_number,
          subdivision,
          builder,
          notes,
          installed_on,
          sensor_logs ( datetime, temp_f, humidity, dewpoint_f )
        `)
        .order("datetime", { foreignTable: "sensor_logs", ascending: false });

      if (error) { console.error(error); return; }

      const container = document.getElementById("cards");
      container.innerHTML = "";

      data.forEach(device => {
        const latestLog = device.sensor_logs?.[0];
        const humidity = latestLog?.humidity ?? "--";
        const temp_f = latestLog?.temp_f ?? "--";
        const dewpoint_f = latestLog?.dewpoint_f ?? "--";
        const updated = latestLog?.datetime 
          ? new Date(latestLog.datetime).toLocaleString()
          : "No recent data";
        const lastSeen = timeAgo(latestLog?.datetime);
        const status = getStatus(humidity, latestLog?.datetime);

        if (currentFilter === "online" && status.text === "OFFLINE") return;
        if (currentFilter === "offline" && status.text !== "OFFLINE") return;

        const card = document.createElement("div");
        card.className = "card";
        if (status.text === "OFFLINE") card.classList.add("offline-card");

        card.innerHTML = `
          <div class="status ${status.class}">${status.text}</div>
          <h2>
            Lot: <span id="lot_number-${device.id}">${device.lot_number || "NEW_DEVICE"}</span>
            <button onclick="editField('${device.id}','lot_number')">✏️</button>
          </h2>
          <div class="editable">Builder: <span id="builder-${device.id}">${device.builder || "UNKNOWN_BUILDER"}</span>
            <button onclick="editField('${device.id}','builder')">✏️</button>
          </div>
          <div class="editable">Subdivision: <span id="subdivision-${device.id}">${device.subdivision || "UNKNOWN_SUBDIVISION"}</span>
            <button onclick="editField('${device.id}','subdivision')">✏️</button>
          </div>
          <div class="editable">Notes: <span id="notes-${device.id}">${device.notes || ""}</span>
            <button onclick="editField('${device.id}','notes')">✏️</button>
          </div>
          <div class="editable">Installed: ${device.installed_on ? new Date(device.installed_on).toLocaleDateString() : "Unknown"}</div>
          <div class="editable">Updated: ${updated}</div>
          <div class="editable">Last Seen: ${lastSeen}</div>
          <div class="metrics">
            <div><b>${humidity}%</b><br/>Humidity</div>
            <div><b>${temp_f}°F</b><br/>Temp</div>
            <div><b>${dewpoint_f}°F</b><br/>Dew Pt</div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    async function editField(deviceId, field) {
      const current = document.getElementById(field + "-" + deviceId).innerText;
      const newValue = prompt(`Update ${field}:`, current);

      if (newValue === null) return;

      let { error } = await db
        .from("devices")
        .update({ [field]: newValue })
        .eq("id", deviceId);

      if (error) {
        alert("Error updating " + field);
        console.error(error);
        return;
      }

      document.getElementById(field + "-" + deviceId).innerText = newValue;
    }

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
