<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cleaning Schedule Site</title>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: sans-serif;
      padding: 1rem;
    }
    input, select, button {
      margin: 0.25rem;
      padding: 0.5rem;
      font-size: 1rem;
      width: 200px;
    }
    optgroup {
      color: #000;
    }
    #scheduleOutput {
      margin-top: 1rem;
      white-space: pre-wrap;
      background: #222;
      padding: 1rem;
    }
    #warning {
      margin-top: 0.5rem;
      color: orange;
      font-weight: bold;
    }
    #lotDataBox {
      margin-top: 1rem;
      background-color: #222;
      color: #ccc;
      padding: 1rem;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.85rem;
    }
    #suggestions {
      background: #333;
      color: white;
      max-height: 150px;
      overflow-y: auto;
      margin: 0.25rem 0;
      border: 1px solid #555;
    }
    .suggestion-item {
      padding: 0.3rem;
      cursor: pointer;
    }
    .suggestion-item:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div id="loadingMessage">Loading lot data...</div>
  <div id="formSection" style="display: none;">
    <input id="lot" placeholder="Lot #" oninput="handleSubdivisionInput(document.getElementById('subdivision').value)" />
    <input id="subdivision" placeholder="Subdivision" oninput="handleSubdivisionInput(this.value); showSubdivisionSuggestions(this.value)" />
    <div id="suggestions"></div>
    <input id="builder" placeholder="Builder" />
    <input id="city" placeholder="City" />
    <input id="address" placeholder="Address" />
    <input id="note" placeholder="Note (optional)" />
    <br>
    <label for="crew">Select Crew:</label>
    <select id="crew">
      <optgroup label="Solo Cleaners">
        <option>Barb</option>
        <option>Brenda</option>
        <option>Marina</option>
        <option>Indira</option>
        <option>Chaley</option>
      </optgroup>
      <optgroup label="Groups">
        <option>Ana/Azalia</option>
        <option>Aracely/Israel</option>
        <option>Belkis/Alexis</option>
        <option>Catalina/Carolina</option>
        <option>Cesia/Juan</option>
        <option>Dolce/Sofia/Darlin</option>
        <option>Gabriela/Yajaira</option>
        <option>Edmundo/Fabiola</option>
        <option>Mario/Odalis</option>
        <option>Melvin/Vilma</option>
        <option>Veronica/Gabriel/Jose/Eva</option>
        <option>Alondra/Socorro</option>
        <option>Daniela/Ada</option>
      </optgroup>
      <optgroup label="Quality Control">
        <option>Dennis</option>
      </optgroup>
      <optgroup label="Supervisor">
        <option>Patty</option>
      </optgroup>
    </select>
    <br>
    <button onclick="addJob()">Add Job</button>

    <div id="scheduleOutput"></div>
    <div id="warning"></div>
    <div id="lotDataBox"></div>
  </div>

  <script>
    let lotData = {};
    let builderData = {};
    const crewJobs = {};

    let lotDataLoaded = false;
    let builderDataLoaded = false;

    fetch("lotData.json")
      .then(res => res.ok ? res.json() : Promise.reject("lotData fetch failed"))
      .then(data => {
        lotData = data;
        lotDataLoaded = true;
        displayLotData();
        checkIfReady();
      })
      .catch(err => console.error("lotData error:", err));

    fetch("builderData.json")
      .then(res => res.ok ? res.json() : Promise.reject("builderData fetch failed"))
      .then(data => {
        builderData = data;
        builderDataLoaded = true;
        checkIfReady();
      })
      .catch(err => console.error("builderData error:", err));

    function checkIfReady() {
      if (lotDataLoaded && builderDataLoaded) {
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("formSection").style.display = "block";
      }
    }

    function displayLotData() {
      const display = document.getElementById("lotDataBox");
      display.textContent = JSON.stringify(lotData, null, 2);
    }

    function showSubdivisionSuggestions(input) {
      const suggestionsBox = document.getElementById("suggestions");
      suggestionsBox.innerHTML = "";
      const query = input.trim().toLowerCase();
      if (!query) return;

      const matches = Object.keys(builderData).filter(sub => sub.toLowerCase().includes(query));

      matches.slice(0, 10).forEach(match => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = match;
        div.onclick = () => {
          document.getElementById("subdivision").value = match;
          suggestionsBox.innerHTML = "";
          handleSubdivisionInput(match);
        };
        suggestionsBox.appendChild(div);
      });
    }

    function handleSubdivisionInput(value) {
      const builder = document.getElementById("builder");
      const city = document.getElementById("city");
      const lot = document.getElementById("lot").value.trim().toUpperCase();
      const address = document.getElementById("address");
      const subdivision = value.trim();
      const warning = document.getElementById("warning");
      warning.textContent = "";

      const match = Object.keys(builderData).find(s => s.toLowerCase() === subdivision.toLowerCase());
      if (match && builderData[match]) {
        builder.value = builderData[match].builder;
        city.value = builderData[match].city;
      } else {
        builder.value = "";
        city.value = "";
      }

      const normalizedLot = lot.replace(/[^\d]/g, '').replace(/^0+/, '');
      const fuzzyMatches = Object.keys(lotData).filter(key => {
        const [lotKey, subKey] = key.split("|").map(s => s.trim().toLowerCase());
        return (
          lotKey.replace(/[^\d]/g, '').replace(/^0+/, '') === normalizedLot.toLowerCase() &&
          subKey.includes(subdivision.toLowerCase())
        );
      });

      if (fuzzyMatches.length === 1) {
        const entry = lotData[fuzzyMatches[0]];
        address.value = entry.address || "";
        if (entry.builder) builder.value = entry.builder;
        if (entry.city) city.value = entry.city;
      } else if (fuzzyMatches.length > 1) {
        warning.textContent = `⚠️ Multiple matches found for lot ${lot} in ${subdivision}`;
        address.value = "";
      } else {
        warning.textContent = `⚠️ No match found for lot ${lot} in ${subdivision}`;
        address.value = "";
      }
    }

    function addJob() {
      const lot = document.getElementById("lot").value.trim();
      const subdivision = document.getElementById("subdivision").value.trim();
      const builder = document.getElementById("builder").value.trim();
      const city = document.getElementById("city").value.trim();
      const address = document.getElementById("address").value.trim();
      const note = document.getElementById("note").value.trim();
      const crew = document.getElementById("crew").value.trim();

      if (!lot || !subdivision || !crew || !address) return alert("Lot, subdivision, address, and crew are required.");

      const job = `*${lot} ${subdivision} *${builder} reclean${note ? "** (" + note + ")" : "*"} – ${address}/${city}`;
      if (!crewJobs[crew]) crewJobs[crew] = [];
      crewJobs[crew].push(job);

      renderSchedule();
    }

    function renderSchedule() {
      const output = document.getElementById("scheduleOutput");
      let result = "";
      for (const crew in crewJobs) {
        result += `\n${crew}\n`;
        crewJobs[crew].forEach(job => result += `${job}\n`);
      }
      output.textContent = result.trim();
    }
  </script>
</body>
</html>
