<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dropbox Photo Uploader</title>
  <style>
    .dropZone { width: 48%; min-height: 200px; border: 2px dashed #888; padding: 10px; margin: 10px 1%; float: left; }
    .dropZone img { max-width: 100%; max-height: 100px; margin: 5px; display: inline-block; }
    #container { overflow: auto; width: 100%; }
    .controls { clear: both; margin-bottom: 10px; }
    .controls label, .controls button, .controls input, .controls select { margin-right: 16px; }
    #log { clear: both; margin-top: 20px; padding: 10px; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; }
    .logEntry { font-size: 0.9em; margin-bottom: 4px; }
  </style>
</head>
<body>
  <h1>Dropbox Photo Uploader</h1>
  <div class="controls">
    <button id="loginBtn">Sign in with Dropbox</button>
    <label>
      Cleaner:
      <select id="cleanerSelect">
       <option value="Ana">Ana</option>
       <option value="Aracely">Aracely</option>
       <option value="Barb">Barb</option>
       <option value="Belkis">Belkis</option>
       <option value="Brenda">Brenda</option>
       <option value="Catalena">Catalena</option>
       <option value="Cesia">Cesia</option>
       <option value="Chaley">Chaley</option>
       <option value="Daniela QC">Daniela (Quality Control)</option>
       <option value="Dennis QC">Dennis (Quality Control)</option>
       <option value="Dolce">Dolce</option>
       <option value="Edmundo">Edmundo</option>
       <option value="Katherine">Katherine</option>
       <option value="Mario">Mario</option>
       <option value="Melvin">Melvin</option>
       <option value="Patty QC">Patty (Quality Control)</option>
       <option value="Sandra">Sandra</option>
       <option value="Veronica">Veronica</option>
        <option>Ana</option>
        <!-- ... -->
      </select>
    </label>
    <label>Job:<input id="jobInput" placeholder="Enter job name" /></label>
    <label>In:<input type="time" id="inTime" /></label>
    <label>Out:<input type="time" id="outTime" /></label>
  </div>
  <div class="controls">
    <button id="uploadBeforeBtn" disabled>Select Before Photos</button>
    <button id="uploadAfterBtn" disabled>Select After Photos</button>
    <input type="file" id="beforeInput" multiple style="display:none" />
    <input type="file" id="afterInput" multiple style="display:none" />
    <button id="submitBtn" disabled>Submit Uploads</button>
  </div>
  <p>Drop your “before” and “after” pictures in separate zones or use the buttons:</p>
  <div id="container">
    <div id="beforeZone" class="dropZone"><strong>Before Photos</strong></div>
    <div id="afterZone" class="dropZone"><strong>After Photos</strong></div>
  </div>
  <div id="log"><h2>Submission Log (Shared)</h2></div>

  <script>
    // === Config ===
    const DROPBOX_CLIENT_ID = 'jn358a9nxupu6rw';
    const REDIRECT_URI = 'https://nmichalski.com/drop';
    const LOG_PATH = '/shared_log.json';
    const PUBLIC_LOG_URL = 'https://www.dropbox.com/scl/fi/tge5w7tu4u1fhblwgwl28/shared_log.json?rlkey=qx59ir0i35e5t9b6afaancuiv&dl=1';

    // === State ===
    let accessToken = null, beforeFiles = [], afterFiles = [], isUploading = false;

    // Append a log entry to UI
    function appendLogEntry(entry) {
      const div = document.createElement('div');
      div.className = 'logEntry';
      div.textContent = entry;
      document.getElementById('log').appendChild(div);
    }

    // Fetch shared log via public URL or API
    async function fetchSharedLog() {
      try {
        const res = await fetch(PUBLIC_LOG_URL);
        if (res.ok) return await res.json();
      } catch {}
      if (accessToken) {
        const res = await fetch('https://content.dropboxapi.com/2/files/download', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Dropbox-API-Arg': JSON.stringify({ path: LOG_PATH })
          }
        });
        if (res.ok) return JSON.parse(await res.text());
      }
      return [];
    }

    // Save shared log via Dropbox API
    async function saveSharedLog(entries) {
      const blob = new Blob([JSON.stringify(entries)], { type: 'application/json' });
      await fetch('https://content.dropboxapi.com/2/files/upload', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + accessToken,
          'Content-Type': 'application/octet-stream',
          'Dropbox-API-Arg': JSON.stringify({ path: LOG_PATH, mode: 'overwrite', autorename: false, mute: true })
        },
        body: blob
      });
    }

    // Load and display shared log
    async function loadLog() {
      const entries = await fetchSharedLog();
      entries.forEach(appendLogEntry);
    }

    // Initialize auth and UI
    async function init() {
      // Parse OAuth token from hash
      const hash = window.location.hash;
      if (hash) {
        const params = new URLSearchParams(hash.slice(1));
        const token = params.get('access_token');
        if (token) {
          accessToken = token;
          // Remove hash for clean URL
          window.history.replaceState(null, '', window.location.pathname);
        }
      }
      // Load log
      await loadLog();
      // If signed in, enable UI
      if (accessToken) {
        document.getElementById('loginBtn').style.display = 'none';
        ['uploadBeforeBtn','uploadAfterBtn','submitBtn'].forEach(id => {
          document.getElementById(id).disabled = false;
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      init();

      document.getElementById('loginBtn').onclick = () => {
        const authUrl =
          `https://www.dropbox.com/oauth2/authorize?response_type=token&client_id=${DROPBOX_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
        window.location.href = authUrl;
      };

      document.getElementById('uploadBeforeBtn').onclick = () =>
        document.getElementById('beforeInput').click();
      document.getElementById('beforeInput').onchange = e => {
        beforeFiles.push(...e.target.files);
        showPreviews('beforeZone', beforeFiles);
      };

      document.getElementById('uploadAfterBtn').onclick = () =>
        document.getElementById('afterInput').click();
      document.getElementById('afterInput').onchange = e => {
        afterFiles.push(...e.target.files);
        showPreviews('afterZone', afterFiles);
      };

      ['beforeZone','afterZone'].forEach(id =>
        setupDropZone(id, id === 'beforeZone' ? 'before' : 'after')
      );

      document.getElementById('submitBtn').onclick = async () => {
        if (!accessToken || isUploading) return;
        isUploading = true;
        const btn = document.getElementById('submitBtn');
        btn.textContent = 'Uploading...';
        ['uploadBeforeBtn','uploadAfterBtn'].forEach(id =>
          document.getElementById(id).disabled = true
        );

        const cleaner = document.getElementById('cleanerSelect').value;
        const jobRaw = document.getElementById('jobInput').value.trim() || 'UnnamedJob';
        const inT = document.getElementById('inTime').value.replace(/:/g, '');
        const outT = document.getElementById('outTime').value.replace(/:/g, '');
        const jobFolder = inT && outT ? `${jobRaw}_${inT}-${outT}` : jobRaw;

        await uploadSection('before', beforeFiles, cleaner, jobFolder);
        await uploadSection('after', afterFiles, cleaner, jobFolder);

        const time = new Date().toLocaleTimeString();
        const entry = `${time} - ${cleaner} - ${jobFolder} (Before: ${beforeFiles.length}, After: ${afterFiles.length})`;
        appendLogEntry(entry);

        const logEntries = await fetchSharedLog();
        logEntries.push(entry);
        await saveSharedLog(logEntries);

        clearFields();
        btn.textContent = 'Submit Uploads';
        ['uploadBeforeBtn','uploadAfterBtn'].forEach(id =>
          document.getElementById(id).disabled = false
        );
        isUploading = false;
      };
    });

    function showPreviews(zoneId, files) {
      const zone = document.getElementById(zoneId);
      zone.innerHTML = `<strong>${zoneId === 'beforeZone' ? 'Before' : 'After'} Photos</strong>`;
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result;
          zone.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }

    function clearFields() {
      beforeFiles = [];
      afterFiles = [];
      ['beforeZone','afterZone'].forEach(z =>
        document.getElementById(z).innerHTML = `<strong>${z === 'beforeZone' ? 'Before' : 'After'} Photos</strong>`
      );
      ['jobInput','inTime','outTime','beforeInput','afterInput'].forEach(id =>
        document.getElementById(id).value = ''
      );
    }

    async function uploadSection(type, files, cleaner, jobFolder) {
      const date = `/${new Date().toISOString().slice(0,10)}`;
      const parts = [date, '/Cleaning', `/${cleaner}`, `/${jobFolder}`, `/${type}`];
      let path = '';
      for (const p of parts) {
        path += p;
        await fetch('https://api.dropboxapi.com/2/files/create_folder_v2', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ path, autorename: false })
        }).catch(() => {});
      }
      for (const file of files) {
        await fetch('https://content.dropboxapi.com/2/files/upload', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/octet-stream',
            'Dropbox-API-Arg': JSON.stringify({ path: path + '/' + file.name, mode: 'add', autorename: true, mute: false })
          },
          body: file
        }).catch(err => console.error('Upload error', err));
      }
    }

    function setupDropZone(id, type) {
      const zone = document.getElementById(id);
      zone.addEventListener('dragover', e => e.preventDefault());
      zone.addEventListener('drop', e => {
        e.preventDefault();
        const files = Array.from(e.dataTransfer.files);
        if (type === 'before') {
          beforeFiles.push(...files);
          showPreviews('beforeZone', beforeFiles);
        } else {
          afterFiles.push(...files);
          showPreviews('afterZone', afterFiles);
        }
      });
    }
  </script>
</body>
</html>
