<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moisture Fleet Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    body { background:#0e1525; color:#fff; font-family:Arial,sans-serif; margin:20px; }
    h1 { margin-bottom:20px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(350px,1fr)); gap:20px; }
    .card {
      background:#1c2333; border-radius:10px; padding:15px;
      box-shadow:0 2px 8px rgba(0,0,0,0.5); position:relative; cursor:pointer;
    }
    .status {
      position:absolute; top:10px; right:10px;
      padding:4px 10px; border-radius:6px; font-weight:bold;
    }
    .ok { background:#1e7d32; }
    .warn { background:#e69500; }
    .alert { background:#c62828; }
    h2 { font-size:16px; margin:0 0 10px; }
    .metrics { display:flex; justify-content:space-between; margin:10px 0; }
    .metric { text-align:center; }
    .metric span { display:block; font-size:20px; font-weight:bold; }
    .notes { font-size:12px; color:#aaa; margin-top:5px; }
    .updated, .installed { font-size:11px; color:#888; margin-top:8px; }
    .details { display:none; margin-top:10px; background:#0f172a; padding:10px; border-radius:8px; }
    table { width:100%; border-collapse:collapse; font-size:12px; margin-bottom:10px; }
    th, td { border:1px solid #444; padding:4px; text-align:center; }
    th { background:#222; }
    .filters { margin:10px 0; }
    .filters button {
      margin-right:5px; padding:5px 10px; border:none; border-radius:4px;
      background:#1c3c5a; color:#fff; cursor:pointer;
    }
    .filters button:hover { background:#2d5b85; }
  </style>
</head>
<body>
  <h1>Basement Humidity — Fleet Dashboard</h1>
  <div class="grid" id="cards"></div>

  <script>
    const { createClient } = supabase;
    const supabaseUrl = "https://imsqijcraukqqopntsmc.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imltc3FpamNyYXVrcXFvcG50c21jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNjQ2NzIsImV4cCI6MjA3MTg0MDY3Mn0.kT7uJbbyEYo-nvrg973B8BLfXmPU5rmcB1bh_ZIXIdM";  // <-- replace with your anon key
    const db = createClient(supabaseUrl, supabaseKey);

    function getStatus(humidity) {
      if (humidity < 65) return {text:"OK", class:"ok"};
      if (humidity < 75) return {text:"WARN", class:"warn"};
      return {text:"ALERT", class:"alert"};
    }

    async function loadData() {
      let { data, error } = await db
        .from("sensor_logs")
        .select(`
          device_id,
          datetime,
          temp_f,
          humidity,
          dewpoint_f,
          devices!sensor_logs_device_id_fkey (
            lot_number,
            subdivision,
            builder,
            notes,
            installed_on
          )
        `)
        .order("datetime", { ascending: false });

      if (error) { console.error(error); return; }

      const latest = {};
      data.forEach(row => {
        if (!latest[row.device_id]) latest[row.device_id] = row;
      });

      const container = document.getElementById("cards");
      container.innerHTML = "";

      for (const [id, row] of Object.entries(latest)) {
        const status = getStatus(row.humidity);
        const updated = new Date(row.datetime).toLocaleString();
        const installDate = row.devices?.installed_on 
            ? new Date(row.devices.installed_on).toLocaleDateString()
            : "Unknown";

        const lot = row.devices?.lot_number || row.device_id;
        const subdivision = row.devices?.subdivision || "Unknown Subdivision";
        const builder = row.devices?.builder || "Unknown Builder";
        const notes = row.devices?.notes || "";

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="status ${status.class}">${status.text}</div>
          <h2>Lot ${lot} • ${builder} • ${subdivision}</h2>
          <div class="metrics">
            <div class="metric"><span>${row.humidity}%</span>Humidity</div>
            <div class="metric"><span>${row.temp_f}°F</span>Temp</div>
            <div class="metric"><span>${row.dewpoint_f}°F</span>Dew Pt</div>
          </div>
          <div class="notes">Notes: ${notes}</div>
          <div class="installed">Installed: ${installDate}</div>
          <div class="updated">Updated: ${updated}</div>
          <div id="details-${row.device_id}" class="details">
            <h3>History</h3>
            <div class="filters">
              <button onclick="loadHistory('${row.device_id}', '1h')">1h</button>
              <button onclick="loadHistory('${row.device_id}', '1d')">1d</button>
              <button onclick="loadHistory('${row.device_id}', '1w')">1w</button>
              <button onclick="loadHistory('${row.device_id}', '1m')">1m</button>
            </div>
            <table>
              <thead><tr><th>Time</th><th>Temp</th><th>Humidity</th><th>Dew Pt</th></tr></thead>
              <tbody id="log-${row.device_id}"></tbody>
            </table>
            <canvas id="chart-${row.device_id}" height="200"></canvas>
          </div>
        `;
        card.onclick = () => toggleDetails(row.device_id);
        container.appendChild(card);
      }
    }

    async function loadHistory(deviceId, range="1d") {
      let since = new Date();
      if (range === "1h") since.setHours(since.getHours() - 1);
      if (range === "1d") since.setDate(since.getDate() - 1);
      if (range === "1w") since.setDate(since.getDate() - 7);
      if (range === "1m") since.setMonth(since.getMonth() - 1);

      const { data, error } = await db
        .from("sensor_logs")
        .select("*")
        .eq("device_id", deviceId)
        .gte("datetime", since.toISOString())
        .order("datetime", { ascending: true });

      if (error) { console.error(error); return; }

      const tbody = document.getElementById("log-" + deviceId);
      tbody.innerHTML = "";
      data.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(r.datetime).toLocaleString()}</td>
          <td>${r.temp_f}°F</td>
          <td>${r.humidity}%</td>
          <td>${r.dewpoint_f}°F</td>
        `;
        tbody.appendChild(tr);
      });

      const ctx = document.getElementById("chart-" + deviceId).getContext("2d");
      if (window["chart_" + deviceId]) {
        window["chart_" + deviceId].destroy();
      }

      window["chart_" + deviceId] = new Chart(ctx, {
        type: "line",
        data: {
          datasets: [
            {
              label: "Temp (°F)",
              data: data.map(r => ({ x: r.datetime, y: r.temp_f })),
              borderColor: "red",
              tension: 0.3
            },
            {
              label: "Humidity (%)",
              data: data.map(r => ({ x: r.datetime, y: r.humidity })),
              borderColor: "blue",
              tension: 0.3
            },
            {
              label: "Dew Pt (°F)",
              data: data.map(r => ({ x: r.datetime, y: r.dewpoint_f })),
              borderColor: "green",
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: "nearest", intersect: false },
          plugins: { legend: { labels: { color: "#fff" } } },
          scales: {
            x: {
              type: "time",
              time: { unit: range === "1h" ? "minute" : range === "1d" ? "hour" : "day" },
              ticks: { color: "#ccc" }
            },
            y: { ticks: { color: "#ccc" } }
          }
        }
      });
    }

    function toggleDetails(deviceId) {
      const details = document.getElementById("details-" + deviceId);
      details.style.display = (details.style.display === "block") ? "none" : "block";
      if (details.style.display === "block") loadHistory(deviceId, "1d");
    }

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
