<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Builder Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    #map { width: 100vw; height: 100vh; }
    .search-box { position: absolute; top:10px; left:50%; transform:translateX(-50%); z-index:1001; background:white; padding:6px 10px; border:1px solid #ccc; border-radius:6px; }
    .builder-toggles, .legend { position:absolute; z-index:1001; background:white; padding:12px 16px; border:1px solid #aaa; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2); font-family:sans-serif; }
    .builder-toggles { top:50px; right:10px; max-height:70vh; overflow-y:auto; }
    .legend { bottom:10px; right:10px; }
    #toggle-ui-btn { position: absolute; top:10px; right:10px; z-index:1002; padding:6px 10px; background:#fff; border:1px solid #aaa; border-radius:4px; cursor:pointer; }
  </style>
</head>
<body>
  <img src="images/logo-VIP.png" alt="Logo" style="position:absolute;bottom:10px;left:10px;height:75px;z-index:1002;">
  <button id="toggle-ui-btn">Hide Controls</button>
  <div class="search-box"><input id="searchInput" placeholder="üîç Search subdivisions..." style="width:250px;padding:4px;" /></div>
  <div class="builder-toggles" id="builderToggles"></div>
  <div class="legend" id="legendBox"><strong>Builder Legend</strong><br>
    <span style="color:green;">‚óè</span> Pulte<br>
    <span style="color:violet;">‚óè</span> Ryan<br>
    <span style="color:black;">‚óè</span> DR Horton<br>
    <span style="color:gold;">‚óè</span> Epcon<br>
    <span style="color:red;">‚óè</span> Shottenstein<br>
    <span style="color:blue;">‚óè</span> Rockford<br>
    <span style="color:orange;">‚óè</span> 3 Pillar<br>
    <span style="color:grey;">‚óè</span> MI Homes<br>
    <span style="color:yellow;">‚óè</span> America Homes 4 Rent
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    // Toggle UI controls
    const toggleBtn = document.getElementById('toggle-ui-btn');
    const togglesDiv = document.getElementById('builderToggles');
    const legendBox = document.getElementById('legendBox');
    let controlsVisible = true;
    toggleBtn.addEventListener('click', () => {
      controlsVisible = !controlsVisible;
      togglesDiv.style.display = controlsVisible ? 'block' : 'none';
      legendBox.style.display = controlsVisible ? 'block' : 'none';
      toggleBtn.textContent = controlsVisible ? 'Hide Controls' : 'Show Controls';
    });

    // Data & config
    const markerData = [ ["Pulte","Abberley","3384 Abberley Drive, New Albany, OH 43054",40.052873,-82.816503],
  ["Pulte","Bloomfield","5002 Roese Ave, South Bloomfield, OH 43103",39.708129,-82.988884],
  ["Pulte","Clarkshaw","3411 Tender Avenue, Powell, OH 43065",40.223191,-83.104699],
  ["Pulte","Glenross","106 E Wind Rd, Delaware, OH 43015",40.236117,-83.020358],
  ["Pulte","Magnolia","Buckeye Cir, Sunbury, OH 43074",40.245262,-82.887000],
  ["Pulte","Price Ponds","1026 Ping Lane, Sunbury, OH 43074",40.244936,-82.890611],
  ["Pulte","Sugar Farms","6344 Zuccaro Dr, Hilliard, OH 43026",39.987856,-83.178413],
  ["Pulte","Towns On The Parkway","4128 John Shields Pkwy, Dublin, OH 43017",40.106649,-83.100162],
  ["Pulte","Amrine","334 Amrine Wy, Marysville, OH 43040",40.270238,-83.371765],
  ["Pulte","Buckstone","4918 Ranger Dr, Lockbourne, OH 43137",39.856655,-82.967935],
  ["Pulte","Clover","40 Reneau Ave, Galloway, OH 43119",39.949993,-83.161864],
  ["Pulte","Jerome Village","8768 Apricot Wy, Plain City, OH 43064",40.187687,-83.189026],
  ["Pulte","Nelson","2538 Nelson Ln, Delaware, OH 43015",40.208450,-83.084053],
  ["Pulte","Berlin Bluffs","2651 Cleo St, Delaware, OH 43015",40.244850,-82.997809],
  ["Pulte","Carpenters","4448 Ruppert Trl, Powell, OH 43065",40.185143,-83.111785],
  ["Pulte","Scotts","9556 Burghley Dr, Plain City, OH 43064",40.154941,-83.214898],
  ["Pulte","Limestone","101 Franks Field Dr, Delaware, OH 43015",40.302692,-83.122495],
  ["Pulte","Nottingham","7715 Nottingham Blvd, New Albany, OH 43054",40.109482,-82.812530],
  ["Pulte","Slate","1121 Oldcastle Road, Lewis Center, OH 43035",40.193908,-83.018517],
  ["Pulte","Beulah","3655 Glacial Ln, Grove City, OH 43123",39.889952,-83.104556],
  ["Pulte","Eagle","7002 Crown Drive, Galena, OH 43021",40.249897,-82.938333],
  ["Pulte","Hyatts","6176 Bishop Blvd, Powell, OH 43065",40.214810,-83.098683],
  ["Pulte","Maeve","2598 McKenna Dr, Delaware, OH 43015",40.236883,-83.005326],
  ["Pulte","Pioneer","9569 Coach Line Ave, Plain City, OH 43064",40.150438,-83.237856],
  ["Pulte","Towns on the Greenway","337 Hockberry Ave, Westerville, OH 43081",40.134287,-82.942262],
  ["DR Horton","Brookview","6541 Pfeifer Ash Dr, Canal Winchester, OH 43110",39.877261,-82.821450],
  ["DR Horton","Lansdowne","4213 Sycamore Oak Avenue, Canal Winchester, OH 43110",39.892490,-82.835370],
  ["DR Horton","Longview","102 Cedarhurst Ct, Pickerington, OH 43147",39.897680,-82.789797],
  ["DR Horton","Madison Meadows","403 Madison Wy, Plain City, OH 43064",40.103927,-83.287352],
  ["DR Horton","Maplewood","1159 Mueller Dr, Reynoldsburg, OH 43068",39.969688,-82.754820],
  ["DR Horton","Monarch Greene","1414 Chrisman Drive, Columbus, OH 43223",39.927510,-83.032780], 
  ["DR Horton","Piatt Preserve","2780 Aldengate Ln, Delaware, OH 43015",40.245506,-83.007530],
  ["DR Horton","River Ridge","1797 Jacko Lane, Circleville, OH 43113",39.635850,-82.948650],
  ["DR Horton","Overlook","2100 Overlook Wy, Newark, OH 43055",40.043237,-82.473669],
  ["DR Horton","Wagnalls","1390 Hansberry Dr, Lithopolis, OH 43136",39.811287,-82.813148],
  ["DR Horton","Walnut","5 Walnut Mill Way, Ashville, OH 43103",39.734237,-82.953590],
  ["Ryan","Terra Alta","581 Pisa Lp, Delaware, OH 43015",40.268005,-83.051701],
  ["Ryan","Rolling Hills","1503 Cypress Pt Dr, Sunbury, OH 43074",40.240643,-82.891371],
  ["Ryan","Glenross","191 Sycamore Ln, Delaware, OH 43015",40.236517,-83.019782],
  ["Ryan","Hyatts","250 Alicia Kelton Dr, Delaware, OH 43015",40.215079,-83.041020],
  ["Epcon","Hyland Meadows","8027 Grassland Dr, Plain City, OH 43064",40.189891,-83.191183],
  ["Epcon","Carr Farms","5755 Arcadian Ave, Hilliard, OH 43026",40.051380,-83.170284],
  ["Epcon","Morse","3347 Duette Dr, New Albany, OH 43054",40.052234,-82.816331],
  ["Epcon","Mulberry","4416 Marilyn Ct, Grove City, OH 43123",39.871459,-83.056351],
  ["Epcon","White Oaks","8400 Ryan Pkwy, Plain City, OH 43064",40.166178,-83.192868],
  ["Epcon","Hyatts Village","3372 Hyatts Rd, Powell, OH 43065",40.217600,-83.108500],
  ["Rockford","Foxfire","440 Bethpage Blvd, Commercial Point, OH 43116",39.777874, -83.029083],
  ["Rockford","HofBauer","2223 Ashby Wy, Plain City, OH 43064",40.114270,-83.269355],
  ["Rockford","Jerome Aster","6981 Aster Wy, Plain City, OH 43064",40.194037, -83.172143],
  ["Rockford","Meadow Grove","1813 Silverlawn Dr, Grove City, OH 43123",39.849346,-83.052656],
  ["Rockford","Willowbend","228 Willow Bnd Dr, Newark, OH 43055",40.047837,-82.485522],
  ["Rockford","Hazelton Crossing","208 Scotsgrove Drive, Pataskala, OH 43062",39.972371, -82.678359],
  ["3 Pillar","Jerome Village","11451 Winterberry Dr, Plain City, OH 43064",40.178976,-83.192238],
  ["3 Pillar","Eversole Woods","11451 Winterberry Drive, Plain City, OH 43064",40.179464,-83.187045],
  ["MI Homes","Pinnacle","899 Heimat Haus Dr, Grove City, OH 43123",39.866539,-83.028943],
  ["MI Homes","Browns Farm","3215 Farmhouse Ln, Grove City, OH 43123",39.857121,-83.089867],
  ["MI Homes","Hill Farm","6960 Gelderland Dr, Hilliard, OH 43026",40.037428,-83.203022],
  ["MI Homes","Foxfire","444 Bethpage Blvd, Commercial Point, OH 43116",39.777897,-83.028864],
  ["MI Homes","Heron","12146 Prairie View Dr NW, Pickerington, OH 43147",39.909728,-82.716874],
  ["MI Homes","Darby","537 Conductor Dr, Plain City, OH 43064",40.107605,-83.250687],
  ["MI Homes","Forest Ridge","106 Ruby Rd SW, Pataskala, OH 43062",40.015704,-82.668855],
  ["MI Homes","Liberty","3777 Shoal Way, Powell, OH 43065",40.201641,-83.103957],
  ["MI Homes","Jerome Village Applewood","10715 Pearl Creek Dr, Plain City, OH 43064",40.169613,-83.199764],
  ["MI Homes","Winterbrooke","43 Sienna Glenn Dr, Lewis Center, OH 43035",40.229418,-83.021288],
  ["MI Homes","Miller Farm","2799 Sunbury Rd, Galena, OH 43021",40.212932,-82.871836],
  ["MI Homes","WoodCrest","6443 Bluejay Rdg Dr, Powell, OH 43065",40.222632,-83.114473],
  ["MI Homes","Berlin Bluffs","2651 Cleo St, Delaware, OH 43015",40.240546,-83.004182],
  ["Shottenstein","Renner","6186 Renner Park Drive, Columbus, OH 43228",39.982893,-83.173465],
  ["Shottenstein","Jerome Aster","6971 Aster Way, Plain City, OH 43064",40.194037,-83.172143],
  ["Shottenstein","Holton","3600 Whirla Way, Grove City, OH",39.858200,-83.098300],
  ["Shottenstein","Cottages At Verbana","11738 Verbena Place, Plain City, OH 43064",40.184323,-83.200862],
  ["Shottenstein","Glacier Pointe","8798 Eliot Drive, Plain City, OH 43064",40.147034, -83.205445],
  ["America Homes 4 Rent","Eastwood","9045 Lucy Drive, Reynoldsburg, OH",39.961474,-82.758526] ];
    const colorMap = { 'Pulte':'green','Ryan':'violet','DR Horton':'black','Epcon':'gold','Shottenstein':'red','Rockford':'blue','3 Pillar':'orange','MI Homes':'grey','America Homes 4 Rent':'yellow' };

    // Initialize map & layers
    const map = L.map('map').setView([40.05, -83.0], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    const routeLayer = L.layerGroup().addTo(map);
    let currentOrigin = null;

    // Build markers
    const builderGroups = {};
    const markers = markerData.map(([builder, name, addr, lat, lon]) => {
      const icon = L.icon({ iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${colorMap[builder]||'blue'}.png`, shadowUrl:'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34] });
      const marker = L.marker([lat, lon], { icon }).addTo(map).bindTooltip(name, { direction: 'top' });
      builderGroups[builder] = builderGroups[builder] || L.layerGroup().addTo(map);
      builderGroups[builder].addLayer(marker);
      return { builder, name, addr, lat, lon, marker };
    });

    // Marker click: immediate popup + loading spinner, then update with data
    markers.forEach(({ builder, name, addr, lat, lon, marker }) => {
      marker.on('click', () => {
        routeLayer.clearLayers();
        currentOrigin = { lat, lon };

        // determine nearest subs by straight-line
        const nearest = markers.filter(m => m.marker !== marker)
          .map(m => ({ ...m, dist: map.distance([lat, lon], [m.lat, m.lon]) }))
          .sort((a, b) => a.dist - b.dist)
          .slice(0, 5);

        // show initial popup with spinner
        const initHtml = `
          <b>${name}</b><br>
          <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank" style="color:inherit;text-decoration:underline;">${addr}</a><br>
          <strong>Closest Subdivisions:</strong>
          <div id="nearest-list">Loading...</div>
        `;
        const popup = L.popup().setLatLng([lat, lon]).setContent(initHtml).openOn(map);

        // fetch actual drive data
        (async () => {
          const withRoute = await Promise.all(nearest.map(async d => {
            const base = `https://router.project-osrm.org/route/v1/driving/${currentOrigin.lon},${currentOrigin.lat};${d.lon},${d.lat}`;
            try {
              const r1 = await fetch(`${base}?overview=false`); const j1 = await r1.json();
              d.duration = j1.routes[0].duration; d.distance = j1.routes[0].distance;
              const r2 = await fetch(`${base}?overview=full&geometries=geojson`); const j2 = await r2.json();
              d.geometry = j2.routes[0].geometry;
            } catch {
              d.duration = (d.dist/1000)/50*3600; d.distance = d.dist;
              d.geometry = { coordinates: [[currentOrigin.lon, currentOrigin.lat],[d.lon, d.lat]] };
            }
            return d;
          }));

          // build final list
          let finalHtml = `
            <b>${name}</b><br>
            <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank" style="color:inherit;text-decoration:underline;">${addr}</a><br>
            <strong>Closest Subdivisions:</strong><ul id="nearest-list">
          `;
          withRoute.forEach((d,i) => {
            const mins = Math.round(d.duration/60);
            const miles = (d.distance/1609.34).toFixed(1);
            const col = mins>30?'black':mins>20?'red':mins>=15?'orange':'green';
            finalHtml += `<li data-index="${i}" style="cursor:pointer;color:${col}">${d.name} - ${mins} min (${miles} mi)</li>`;
          });
          finalHtml += '</ul>';

          // update popup content
          popup.setContent(finalHtml);

          // attach click handlers for route drawing
          document.querySelectorAll('#nearest-list li').forEach(li => {
            li.addEventListener('click', () => {
              routeLayer.clearLayers();
              const d = withRoute[li.dataset.index];
              const coords = d.geometry.coordinates.map(c => [c[1], c[0]]);
              L.polyline(coords, { color: 'blue', weight: 8 }).addTo(routeLayer);
              map.fitBounds(L.polyline(coords).getBounds());
            });
          });
        })();
      });
    });

    // Builder toggles UI controls
    ['Select All','Select None'].forEach(txt => {
      const btn = document.createElement('button'); btn.textContent = txt; btn.style.marginRight = '8px';
      btn.addEventListener('click', () => {
        Object.values(builderGroups).forEach(group => txt==='Select All' ? group.addTo(map) : map.removeLayer(group));
        document.querySelectorAll('#builderToggles input').forEach(cb => cb.checked = (txt==='Select All'));
      });
      togglesDiv.appendChild(btn);
    }); togglesDiv.appendChild(document.createElement('br'));
    Object.entries(builderGroups).forEach(([b, group]) => {
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=true;
      cb.addEventListener('change', () => cb.checked ? group.addTo(map) : map.removeLayer(group));
      const lbl = document.createElement('label'); lbl.appendChild(cb); lbl.append(` ${b}`);
      togglesDiv.appendChild(lbl); togglesDiv.appendChild(document.createElement('br'));
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function() {
      const q = this.value.toLowerCase(); const f = markers.find(m => m.name.toLowerCase().includes(q));
      if (f) map.setView([f.lat, f.lon], 14);
    });
  </script>
</body>
</html>
